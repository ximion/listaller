#!/bin/sh
set -e

#Set paths
GEN="../build/util/bindingtool"
PASBINDDIR="../src/bind"
COUT="./linst-cbind"
LIBSRC="./listaller/liblistaller.lpr"

if [ -e $GEN ]; then
  #Update Pascal bindings
  echo "Updating Pascal bindings..."
  $GEN --pasbind -i $LIBSRC --cmp="BaseFunctions" -o $PASBINDDIR/libasic.pas
  $GEN --pasbind -i $LIBSRC --cmp="AppItem" -o $PASBINDDIR/liappitem.pas
  $GEN --pasbind -i $LIBSRC --cmp="Manager" -o $PASBINDDIR/liappmgr.pas
  $GEN --pasbind -i $LIBSRC --cmp="Installer" -o $PASBINDDIR/liinstaller.pas
  $GEN --pasbind -i $LIBSRC --cmp="Updater" -o $PASBINDDIR/liappupdate.pas

  #Generate C headers
  echo "Generating C bindings..."
  $GEN --pastoc -i $PASBINDDIR/libasic.pas -o $COUT/li-basics.h --template=$COUT/cheader.template
  $GEN --pastoc -i $PASBINDDIR/liappitem.pas -o $COUT/li-appitem.h --template=$COUT/cheader.template
  $GEN --pastoc -i $PASBINDDIR/liappmgr.pas -o $COUT/li-manager.h --template=$COUT/cheader.template
  $GEN --pastoc -i $PASBINDDIR/liinstaller.pas -o $COUT/li-installer.h --template=$COUT/cheader.template
  $GEN --pastoc -i $PASBINDDIR/liappupdate.pas -o $COUT/li-updater.h --template=$COUT/cheader.template
  $GEN --pastoc -i ../src/litypes.pas -o $COUT/li-types.h --template=$COUT/cheader.template

  sh ./makepkbind

  echo "Finished."
else
 echo "BindingTool was not found!"
 exit 1
fi
