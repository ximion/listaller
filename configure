#!/bin/bash
#
# Check if all required components are present to build Listaller
#
# syntax :
#    ./configure <options> [parameters]
set -e
OPTION_SPEC="help,enable-qt,enable-creator,enable-gtk,enable-frontends,enable-all,cmake-options:"
PARSED_OPTIONS=$(getopt -n "$0" -a -o h --l "$OPTION_SPEC" -- "$@")

eval set -- "$PARSED_OPTIONS"

function usage
{
  echo "Usage:"
  echo " ./configure <options> [parameters]"
  echo "Use --enable-<option> to enable features for build."
}

if [ $? != 0 ] ; then usage ; exit 1 ; fi

while true ; do
	case "$1" in
		-h|--help )  usage; exit 0;;
		--enable-qt )  ENABLE_QT=1; shift; ;;
		--enable-gtk )  ENABLE_GTK=1; shift; ;;
		--enable-frontends )  ENABLE_FRONT=1; shift; ;;
		--enable-all ) ENABLE_QT=1; ENABLE_GTK=1; ENABLE_CREATOR=1; ENABLE_FRONT=1; shift; ;;
		--cmake-options ) case "$2" in
			    "") echo "CMake-Options need an argument!"; exit 3 ;;
			     *) export cmakeoptn=$2 ; shift 2 ;;
			   esac ;;

		--) shift ; break ;;
		* ) echo "ERROR: unknown flag $1"; exit 2;;
	esac
done

if [ ! -e "$(pwd)/Makefile.in" ]; then
  echo "Makefile template was not found."
  echo "Please cd to the Listaller source directory."
  exit 8
fi

CMAKE=$(which cmake)
if ([ ! -e $CMAKE ]||[ "$CMAKE" == '' ]); then
  echo "CMake was not found! Please install cmake."
  exit 8
fi

sed "s#%PREFIX%#$prefix#" Makefile.in > Makefile

CMAKE_OPTIONS=$cmakeoptn
if [ "$ENABLE_QT" = "1" ]; then
 CMAKE_OPTIONS="$CMAKE_OPTIONS -DQT=ON"
fi
if [ "$ENABLE_GTK" = "1" ]; then
 CMAKE_OPTIONS="$CMAKE_OPTIONS -DGTK=ON"
fi
if [ "$ENABLE_FRONT" = "1" ]; then
 CMAKE_OPTIONS="$CMAKE_OPTIONS -DFRONTENDS=ON"
fi

mkdir -p build
cd build
cmake $CMAKE_OPTIONS ..
cd ..

echo
echo "Summary:"
echo
echo "Listaller will be built with the following features:"
echo " Daemon and library: enabled"
echo " Command-Line tools: enabled"
if [ "$ENABLE_QT" = "1" ]; then
 echo " Qt4 widgetset:      enabled"
else
 echo " Qt4 widgetset:      disabled"
fi
if [ "$ENABLE_GTK" = "1" ]; then
 echo " GTK2 widgetset:     enabled"
else
 echo " GTK2 widgetset:     disabled"
fi
if [ "$ENABLE_FRONT" = "1" ]; then
 echo " GUI Frontends:      enabled"
else
 echo " GUI Frontends:      disabled"
fi
if [ "$ENABLE_CREATOR" = "1" ]; then
 echo " Setup creator GUI:  enabled"
else
 echo " Setup creator GUI:  disabled"
fi
echo
echo "You can now run make"
echo "then make install"
echo
